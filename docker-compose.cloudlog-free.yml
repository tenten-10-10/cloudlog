services:
  cloudlog:
    build: .
    restart: unless-stopped
    command: ["python", "-m", "sitewatcher", "cloudlog-web", "--host", "0.0.0.0", "--port", "8010", "--data-dir", "/data"]
    env_file:
      - .env.cloudlog
    environment:
      CLOUDLOG_DATA_DIR: /data
      CLOUDLOG_ALLOW_REGISTRATION: "${CLOUDLOG_ALLOW_REGISTRATION:-1}"
      CLOUDLOG_HTTPS_ONLY: "0"
      CLOUDLOG_ALLOWED_HOSTS: "${CLOUDLOG_ALLOWED_HOSTS:-localhost,127.0.0.1}"
      CLOUDLOG_ADMIN_USER: "${CLOUDLOG_ADMIN_USER:-admin}"
      CLOUDLOG_ADMIN_PASSWORD: "${CLOUDLOG_ADMIN_PASSWORD:-admin1234}"
      CLOUDLOG_SECRET_KEY: "${CLOUDLOG_SECRET_KEY:-change-this-in-production}"
    ports:
      - "8010:8010"
    volumes:
      - ./.cloudlog:/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8010/health', timeout=3).read()"]
      interval: 20s
      timeout: 5s
      retries: 5

  cloudflared:
    image: cloudflare/cloudflared:latest
    profiles: ["public"]
    depends_on:
      cloudlog:
        condition: service_healthy
    command: ["tunnel", "--no-autoupdate", "--url", "http://cloudlog:8010"]
    restart: unless-stopped
