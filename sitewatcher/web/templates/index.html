{% extends "base.html" %}
{% block content %}
  <div class="panel">
    <div class="row-between">
      <div>
        <div class="row">
          <div class="pill">Interval: <strong>{{ interval_seconds }}s</strong></div>
          {% if scheduler_enabled %}
            <div class="tag ok">Scheduler ON</div>
          {% else %}
            <div class="tag bad">Scheduler OFF</div>
          {% endif %}
          {% if notify_on_first %}
            <div class="tag">Notify on first: ON</div>
          {% else %}
            <div class="tag">Notify on first: OFF</div>
          {% endif %}
        </div>
        <div class="hint">
          Enabled notifiers:
          {% for n in notifiers %}
            {% if n.enabled %}
              <span class="tag">{{ n.name }}</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <div class="pill">
        Last run:
        {% if last_run %}
          <span class="tag {% if last_run.status == 'ok' %}ok{% elif last_run.status == 'error' %}bad{% endif %}">{{ last_run.status }}</span>
          <span class="muted">{{ format_ts(last_run.started_at) }}</span>
        {% else %}
          <span class="muted">-</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="row-between">
      <div>
        <h2 style="margin:0">Targets</h2>
        <div class="hint">UIで追加/編集して監視できます。</div>
      </div>
      <a class="btn primary" href="/targets/new">+ Add</a>
    </div>

    <div style="margin-top:12px">
      <table class="table">
        <thead>
          <tr>
            <th>Enabled</th>
            <th>Name</th>
            <th>Type</th>
            <th>URL / Selector</th>
            <th>Notify</th>
            <th>Checked</th>
            <th>Changed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for t in targets %}
            {% set st = state_map.get(t.id) %}
            <tr>
              <td>
                {% if t.enabled %}
                  <span class="tag ok">ON</span>
                {% else %}
                  <span class="tag bad">OFF</span>
                {% endif %}
              </td>
              <td><strong>{{ t.name }}</strong></td>
              <td><span class="tag">{{ t.type }}</span></td>
              <td>
                <div><a href="{{ t.url }}" target="_blank" rel="noreferrer">{{ t.url }}</a></div>
                {% if t.type == 'html' and t.selector %}
                  <div class="muted" style="margin-top:6px">selector: <code>{{ t.selector }}</code></div>
                {% endif %}
              </td>
              <td class="muted">
                {% if t.notify %}
                  {% for n in t.notify %}
                    <span class="tag">{{ n }}</span>
                  {% endfor %}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="muted">{{ format_ts(st.checked_at if st else None) }}</td>
              <td class="muted">{{ format_ts(st.changed_at if st else None) }}</td>
              <td>
                <div class="row">
                  <a class="btn" href="/targets/{{ t.id }}/edit">Edit</a>
                  <form method="post" action="/targets/{{ t.id }}/delete">
                    <button class="btn danger" type="submit" data-confirm="Delete target '{{ t.name }}'?">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

