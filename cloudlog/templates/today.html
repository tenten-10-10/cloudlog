{% extends "base.html" %}
{% block content %}
{% set primary_mode = "出勤" %}
{% set primary_action = "clock-in" %}
{% set primary_endpoint = "/events/clock-in" %}
{% if status == "出勤済" %}
  {% set primary_mode = "退勤" %}
  {% set primary_action = "clock-out" %}
  {% set primary_endpoint = "/events/clock-out" %}
{% elif status == "退勤済" %}
  {% set primary_mode = "完了" %}
  {% set primary_action = "done" %}
  {% set primary_endpoint = "/events/clock-out" %}
{% endif %}

{% set secondary_mode = "外出" %}
{% set secondary_action = "outing" %}
{% set secondary_endpoint = "/events/outing" %}
{% if status != "出勤済" %}
  {% set secondary_mode = "外出/戻り" %}
  {% set secondary_action = "disabled" %}
  {% set secondary_endpoint = "/events/outing" %}
{% elif is_outing_now %}
  {% set secondary_mode = "戻り" %}
  {% set secondary_action = "return" %}
  {% set secondary_endpoint = "/events/return" %}
{% endif %}

<section class="panel today-hero">
  <div class="today-hero__grid">
    <article class="today-main">
      <div class="headline-row">
        <div>
          <p class="kicker">Today / JST</p>
          <h1>本日の打刻</h1>
          <p class="muted">{{ today }}</p>
        </div>
        <span class="status-pill" id="today-status">{{ status }}</span>
      </div>

      <div class="clock-face">
        <div class="clock-hero-row">
          <div class="clock-main">
            <p class="clock-caption">現在時刻</p>
            <p class="live-clock live-clock--hero" id="live-clock" aria-live="polite">--:--:--</p>
            <p class="clock-subtext" id="live-clock-date">----</p>
          </div>

          <form
            method="post"
            action="{{ primary_endpoint }}"
            class="primary-clock-form"
            id="primary-clock-form"
            data-clock-action="{{ primary_action }}"
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <button class="btn btn--xl btn--primary-clock" id="primary-clock-btn" type="submit" {% if primary_action == 'done' %}disabled{% endif %}>
              {{ '本日の打刻完了' if primary_action == 'done' else primary_mode }}
            </button>
          </form>
        </div>
      </div>
    </article>

    <div class="today-side">
      <section class="today-times-card" aria-label="今日の打刻時刻">
        <h2>今日の打刻時刻</h2>
        <dl class="today-times-grid">
          <div>
            <dt>出勤</dt>
            <dd id="clock-in-value">{{ record.clock_in or '—' }}</dd>
            <p class="today-times-sub" id="clock-in-sub">{{ '記録済み' if record.clock_in else '未打刻' }}</p>
          </div>
          <div>
            <dt>退勤</dt>
            <dd id="clock-out-value">{{ record.clock_out or '—' }}</dd>
            <p class="today-times-sub" id="clock-out-sub">{{ '記録済み' if record.clock_out else '未打刻' }}</p>
          </div>
        </dl>
      </section>

      <details class="outing-log">
        <summary>外出 / 戻り（必要時に確認）</summary>
        <div class="outing-log__body">
          <div class="outing-lists">
            <section>
              <h3>外出</h3>
              <ul class="time-list" id="outing-list">
                <li class="time-list__empty">記録なし</li>
              </ul>
            </section>
            <section>
              <h3>戻り</h3>
              <ul class="time-list" id="return-list">
                <li class="time-list__empty">記録なし</li>
              </ul>
            </section>
          </div>

          <div class="secondary-actions secondary-actions--sub">
            <form
              method="post"
              action="{{ secondary_endpoint }}"
              id="secondary-action-form"
              data-clock-action="{{ secondary_action }}"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button
                class="btn btn--small btn--ghost"
                id="secondary-action-btn"
                type="submit"
                {% if secondary_action == 'disabled' %}disabled{% endif %}
              >
                {{ secondary_mode }}
              </button>
            </form>
          </div>
        </div>
      </details>
    </div>
  </div>
</section>

<section class="panel kpi-panel">
  <div class="kpi-strip" role="list" aria-label="今期サマリー">
    <article class="kpi-item" role="listitem">
      <h2>今期就業</h2>
      <p>{{ minutes_to_hhmm(summary.work_minutes) }}</p>
    </article>
    <article class="kpi-item" role="listitem">
      <h2>残業</h2>
      <p>{{ minutes_to_hhmm(summary.overtime_minutes) }}</p>
    </article>
    <article class="kpi-item" role="listitem">
      <h2>未入力</h2>
      <p>{{ summary.missing_count }}日</p>
    </article>
  </div>
</section>

<div id="today-flash" data-message="{{ flash_message or '' }}" data-error="{{ flash_error or '' }}" hidden></div>
<script id="today-events-json" type="application/json">{{ (record.events or []) | tojson }}</script>
<div class="toast-viewport" id="clock-toast-region" aria-live="polite" aria-atomic="false"></div>

<script>
  (() => {
    const clockEl = document.getElementById("live-clock");
    const dateEl = document.getElementById("live-clock-date");
    const flashNode = document.getElementById("today-flash");
    const toastRegion = document.getElementById("clock-toast-region");
    const statusEl = document.getElementById("today-status");
    const primaryForm = document.getElementById("primary-clock-form");
    const primaryButton = document.getElementById("primary-clock-btn");
    const secondaryForm = document.getElementById("secondary-action-form");
    const secondaryButton = document.getElementById("secondary-action-btn");
    const eventsNode = document.getElementById("today-events-json");
    const forms = document.querySelectorAll("form[data-clock-action]");

    if (!clockEl || !dateEl || !toastRegion || !forms.length) return;

    const clockFmt = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
    const dateFmt = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      weekday: "short",
    });
    const ymdFmt = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });

    const escapeHtml = (text) =>
      String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");

    const showToast = (message, kind = "ok") => {
      if (!message) return;
      const toast = document.createElement("div");
      toast.className = `toast toast--${kind}`;
      toast.innerHTML = `
        <p>${escapeHtml(message)}</p>
        <button type="button" class="toast__close" aria-label="閉じる">×</button>
      `;
      toastRegion.appendChild(toast);

      const remove = () => {
        toast.classList.add("toast--closing");
        window.setTimeout(() => toast.remove(), 180);
      };

      toast.querySelector(".toast__close")?.addEventListener("click", remove);
      window.setTimeout(remove, 3800);
    };

    const parseTime = (iso) => {
      if (!iso) return null;
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return null;
      return dt;
    };

    const formatTime = (iso) => {
      const dt = parseTime(iso);
      return dt ? clockFmt.format(dt) : "";
    };

    const formatEventStamp = (iso) => {
      const dt = parseTime(iso);
      if (!dt) return "";
      return `${ymdFmt.format(dt).replaceAll("/", "-")} ${clockFmt.format(dt)}`;
    };

    const setTimeCell = (valueId, subId, value) => {
      const valueNode = document.getElementById(valueId);
      const subNode = document.getElementById(subId);
      const filled = Boolean(value);
      if (valueNode) valueNode.textContent = filled ? value : "—";
      if (subNode) subNode.textContent = filled ? "記録済み" : "未打刻";
    };

    const isOutingNow = (events) => {
      const travel = (Array.isArray(events) ? events : [])
        .filter((ev) => ev?.event_type === "OUTING" || ev?.event_type === "RETURN")
        .sort((a, b) => String(a?.event_time || "").localeCompare(String(b?.event_time || "")));
      if (!travel.length) return false;
      return travel[travel.length - 1].event_type === "OUTING";
    };

    const syncPrimaryAction = (status) => {
      if (!primaryForm || !primaryButton) return;
      if (status === "未出勤") {
        primaryForm.action = "/events/clock-in";
        primaryForm.dataset.clockAction = "clock-in";
        primaryButton.disabled = false;
        primaryButton.textContent = "出勤";
        return;
      }
      if (status === "出勤済") {
        primaryForm.action = "/events/clock-out";
        primaryForm.dataset.clockAction = "clock-out";
        primaryButton.disabled = false;
        primaryButton.textContent = "退勤";
        return;
      }
      primaryForm.dataset.clockAction = "done";
      primaryButton.disabled = true;
      primaryButton.textContent = "本日の打刻完了";
    };

    const syncSecondaryAction = (status, events) => {
      if (!secondaryForm || !secondaryButton) return;
      if (status !== "出勤済") {
        secondaryForm.action = "/events/outing";
        secondaryForm.dataset.clockAction = "disabled";
        secondaryButton.textContent = "外出/戻り";
        secondaryButton.disabled = true;
        return;
      }

      if (isOutingNow(events)) {
        secondaryForm.action = "/events/return";
        secondaryForm.dataset.clockAction = "return";
        secondaryButton.textContent = "戻り";
      } else {
        secondaryForm.action = "/events/outing";
        secondaryForm.dataset.clockAction = "outing";
        secondaryButton.textContent = "外出";
      }
      secondaryButton.disabled = false;
    };

    const renderTimeList = (id, values) => {
      const target = document.getElementById(id);
      if (!target) return;
      target.innerHTML = "";
      if (!values.length) {
        const li = document.createElement("li");
        li.className = "time-list__empty";
        li.textContent = "記録なし";
        target.appendChild(li);
        return;
      }
      values.forEach((value) => {
        const li = document.createElement("li");
        li.className = "time-list__item";
        li.textContent = value;
        target.appendChild(li);
      });
    };

    const renderOutingReturn = (events) => {
      const outing = [];
      const returning = [];
      (Array.isArray(events) ? events : []).forEach((ev) => {
        const time = formatTime(ev?.event_time);
        if (!time) return;
        if (ev?.event_type === "OUTING") outing.push(time);
        if (ev?.event_type === "RETURN") returning.push(time);
      });
      renderTimeList("outing-list", outing);
      renderTimeList("return-list", returning);
    };

    const patchTodayView = async () => {
      const res = await fetch("/attendance/today", { headers: { Accept: "application/json" } });
      if (!res.ok) return;
      const payload = await res.json();
      if (!payload?.ok) return;

      if (statusEl && payload.status) statusEl.textContent = payload.status;
      syncPrimaryAction(payload.status || "");
      syncSecondaryAction(payload.status || "", payload?.record?.events || []);

      const rec = payload.record || {};
      setTimeCell("clock-in-value", "clock-in-sub", rec.clock_in);
      setTimeCell("clock-out-value", "clock-out-sub", rec.clock_out);
      renderOutingReturn(rec.events || []);
    };

    const submitClock = async (form) => {
      const actionKind = form.dataset.clockAction || "";
      if (actionKind === "done") {
        showToast("本日の打刻は完了しています", "error");
        return;
      }
      if (actionKind === "disabled") {
        showToast("勤務中のみ操作できます", "error");
        return;
      }

      const submit = form.querySelector("button[type='submit']");
      if (submit) submit.disabled = true;
      form.classList.add("is-submitting");

      try {
        const res = await fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: { Accept: "application/json" },
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok || !payload?.ok) {
          const reason = payload?.error ? `: ${payload.error}` : "";
          showToast(`打刻に失敗しました${reason}`, "error");
          return;
        }

        const stamp = formatEventStamp(payload?.event?.event_time);
        showToast(stamp ? `打刻しました: ${stamp}` : "打刻しました", "ok");
        await patchTodayView();
      } catch (_err) {
        showToast("打刻に失敗しました", "error");
      } finally {
        if (submit && actionKind !== "done" && actionKind !== "disabled") submit.disabled = false;
        form.classList.remove("is-submitting");
      }
    };

    forms.forEach((form) => {
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        submitClock(form);
      });
    });

    const tick = () => {
      const now = new Date();
      clockEl.textContent = clockFmt.format(now);
      dateEl.textContent = dateFmt.format(now).replaceAll("/", ".");
    };

    tick();
    window.setInterval(tick, 1000);

    let initialEvents = [];
    try {
      initialEvents = JSON.parse(eventsNode?.textContent || "[]");
    } catch (_err) {
      initialEvents = [];
    }
    renderOutingReturn(initialEvents);
    syncPrimaryAction(statusEl?.textContent || "");
    syncSecondaryAction(statusEl?.textContent || "", initialEvents);

    const initialMessage = flashNode?.dataset?.message || "";
    const initialError = flashNode?.dataset?.error || "";
    if (initialMessage) showToast(initialMessage, "ok");
    if (initialError) showToast(initialError, "error");
  })();
</script>
{% endblock %}
