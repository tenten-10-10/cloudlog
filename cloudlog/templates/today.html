{% extends "base.html" %}
{% block content %}
{% set primary_mode = "出勤" %}
{% set primary_action = "clock-in" %}
{% set primary_endpoint = "/events/clock-in" %}
{% if status == "出勤済" %}
  {% set primary_mode = "退勤" %}
  {% set primary_action = "clock-out" %}
  {% set primary_endpoint = "/events/clock-out" %}
{% elif status == "退勤済" %}
  {% set primary_mode = "退勤済" %}
  {% set primary_action = "done" %}
  {% set primary_endpoint = "/events/clock-out" %}
{% endif %}

{% set secondary_mode = "外出" %}
{% set secondary_action = "outing" %}
{% set secondary_endpoint = "/events/outing" %}
{% if status != "出勤済" %}
  {% set secondary_mode = "外出/戻り" %}
  {% set secondary_action = "disabled" %}
  {% set secondary_endpoint = "/events/outing" %}
{% elif is_outing_now %}
  {% set secondary_mode = "戻り" %}
  {% set secondary_action = "return" %}
  {% set secondary_endpoint = "/events/return" %}
{% endif %}

<section class="panel today-shell">
  <div class="today-shell__head">
    <div>
      <p class="kicker">Today / JST</p>
      <h1>本日の打刻</h1>
      <p class="muted">{{ today }}</p>
    </div>
    <span class="status-pill" id="today-status">{{ status }}</span>
  </div>

  <div class="today-shell__grid">
    <article class="hero-card">
      <div class="hero-card__clock">
        <p class="clock-caption">現在時刻</p>
        <p class="live-clock live-clock--hero" id="live-clock" aria-live="polite">--:--:--</p>
        <p class="clock-subtext" id="live-clock-date">----</p>
      </div>

      <form
        method="post"
        action="{{ primary_endpoint }}"
        class="primary-clock-form"
        id="primary-clock-form"
        data-clock-action="{{ primary_action }}"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <button class="btn btn--xl btn--primary-clock" id="primary-clock-btn" type="submit" {% if primary_action == 'done' %}disabled{% endif %}>
          {{ primary_mode }}
        </button>
      </form>

      <div class="hero-toast-slot" id="clock-toast-region" aria-live="polite" aria-atomic="false"></div>
    </article>

    <aside class="today-side-stack">
      <section class="today-times-card" aria-label="今日の打刻時刻">
        <h2>今日の打刻時刻</h2>
        <dl class="today-times-grid">
          <div>
            <dt>出勤</dt>
            <dd id="clock-in-value">{{ record.clock_in or '—' }}</dd>
            <p class="today-times-sub" id="clock-in-sub">{{ '記録済み' if record.clock_in else '未打刻' }}</p>
          </div>
          <div>
            <dt>退勤</dt>
            <dd id="clock-out-value">{{ record.clock_out or '—' }}</dd>
            <p class="today-times-sub" id="clock-out-sub">{{ '記録済み' if record.clock_out else '未打刻' }}</p>
          </div>
        </dl>
      </section>

      <details class="outing-log" id="outing-accordion">
        <summary class="outing-log__summary">
          <span>外出 / 戻り（必要時に確認）</span>
          <span class="outing-log__meta" id="outing-count">0件</span>
          <span class="accordion-chevron" aria-hidden="true"></span>
        </summary>
        <div class="outing-log__body">
          <div class="secondary-actions secondary-actions--sub">
            <form
              method="post"
              action="{{ secondary_endpoint }}"
              id="secondary-action-form"
              data-clock-action="{{ secondary_action }}"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button
                class="btn btn--small btn--ghost"
                id="secondary-action-btn"
                type="submit"
                {% if secondary_action == 'disabled' %}disabled{% endif %}
              >
                {{ secondary_mode }}
              </button>
            </form>
          </div>

          <div class="outing-lists">
            <section>
              <h3>外出</h3>
              <ul class="time-list" id="outing-list">
                <li class="time-list__empty">記録なし</li>
              </ul>
            </section>
            <section>
              <h3>戻り</h3>
              <ul class="time-list" id="return-list">
                <li class="time-list__empty">記録なし</li>
              </ul>
            </section>
          </div>
        </div>
      </details>
    </aside>
  </div>
</section>

<section class="panel kpi-panel">
  <div class="kpi-strip" role="list" aria-label="今期サマリー">
    <article class="kpi-item" role="listitem">
      <h2>今期就業</h2>
      <p id="kpi-work">{{ minutes_to_hhmm(summary.work_minutes) }}</p>
      <p class="kpi-mom" id="kpi-work-mom">
        {% if mom.percent_change is not none %}
          <span class="{{ 'gain' if mom.percent_change >= 0 else 'loss' }}">前月比 {{ '+' if mom.percent_change > 0 else '' }}{{ mom.percent_change }}%</span>
        {% else %}
          <span class="muted">前月比 —</span>
        {% endif %}
      </p>
      <p class="kpi-note">締め日 {{ closing_day }}日</p>
    </article>
    <article class="kpi-item" role="listitem">
      <h2>残業</h2>
      <p id="kpi-overtime">{{ minutes_to_hhmm(summary.overtime_minutes) }}</p>
    </article>
    <article class="kpi-item" role="listitem">
      <h2>未入力</h2>
      <p id="kpi-missing">{{ summary.missing_count }}日</p>
    </article>
  </div>
</section>

<section class="panel history-panel" aria-label="直近の打刻履歴">
  <div class="history-panel__head">
    <div>
      <h2>直近の打刻履歴</h2>
      <p class="muted">最新10件。編集内容は履歴として追記されます。</p>
    </div>
  </div>
  <div class="history-table-wrap">
    <table class="table punch-history">
      <thead>
        <tr>
          <th>日時</th>
          <th>種別</th>
          <th>備考</th>
          <th>区分</th>
          <th>修正</th>
        </tr>
      </thead>
      <tbody id="recent-events-body">
        {% if recent_events %}
          {% for ev in recent_events %}
          <tr
            data-event-id="{{ ev.event_id }}"
            data-event-type="{{ ev.event_type }}"
            data-event-time="{{ ev.event_time_input }}"
            data-event-note="{{ ev.note }}"
          >
            <td>{{ ev.event_time_label }}</td>
            <td>{{ ev.event_type_label }}</td>
            <td>{{ ev.note or '—' }}</td>
            <td>
              {% if ev.is_edited %}
              <span class="status status--submitted">修正</span>
              {% else %}
              <span class="status">通常</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn--small btn--ghost history-edit-btn" type="button">編集</button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="muted">打刻履歴がありません</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<div class="modal-backdrop" id="event-edit-backdrop" hidden></div>
<section class="event-edit-modal" id="event-edit-modal" role="dialog" aria-modal="true" aria-labelledby="event-edit-title" hidden>
  <header class="event-edit-modal__header">
    <h3 id="event-edit-title">打刻修正</h3>
    <button type="button" class="icon-btn" id="event-edit-close" aria-label="閉じる">×</button>
  </header>
  <p class="muted">この修正は履歴として保存されます。</p>
  <form id="event-edit-form" class="form-grid compact">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
    <input type="hidden" name="event_id" id="edit-event-id" />
    <label>
      打刻日時（JST）
      <input type="datetime-local" name="event_time" id="edit-event-time" step="1" required />
    </label>
    <label>
      種別
      <select name="event_type" id="edit-event-type" required>
        <option value="IN">出勤</option>
        <option value="OUT">退勤</option>
        <option value="OUTING">外出</option>
        <option value="RETURN">戻り</option>
      </select>
    </label>
    <label class="wide">
      備考（任意）
      <textarea name="note" id="edit-event-note" placeholder="修正理由やメモ"></textarea>
    </label>
    <div class="row-actions">
      <button class="btn btn--ghost" type="button" id="event-edit-cancel">キャンセル</button>
      <button class="btn btn--primary" type="submit" id="event-edit-submit">保存</button>
    </div>
  </form>
</section>

<div id="today-flash" data-message="{{ flash_message or '' }}" data-error="{{ flash_error or '' }}" hidden></div>

<script>
  (() => {
    const clockEl = document.getElementById("live-clock");
    const dateEl = document.getElementById("live-clock-date");
    const flashNode = document.getElementById("today-flash");
    const toastRegion = document.getElementById("clock-toast-region");
    const statusEl = document.getElementById("today-status");
    const primaryForm = document.getElementById("primary-clock-form");
    const primaryButton = document.getElementById("primary-clock-btn");
    const secondaryForm = document.getElementById("secondary-action-form");
    const secondaryButton = document.getElementById("secondary-action-btn");
    const recentBody = document.getElementById("recent-events-body");

    const modal = document.getElementById("event-edit-modal");
    const modalBackdrop = document.getElementById("event-edit-backdrop");
    const editForm = document.getElementById("event-edit-form");
    const editClose = document.getElementById("event-edit-close");
    const editCancel = document.getElementById("event-edit-cancel");
    const editSubmit = document.getElementById("event-edit-submit");
    const editEventId = document.getElementById("edit-event-id");
    const editEventTime = document.getElementById("edit-event-time");
    const editEventType = document.getElementById("edit-event-type");
    const editEventNote = document.getElementById("edit-event-note");

    if (!clockEl || !dateEl || !toastRegion || !statusEl) return;

    const clockFmt = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
    });
    const dateFmt = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      weekday: "short",
    });
    const ymdFmt = new Intl.DateTimeFormat("ja-JP", {
      timeZone: "Asia/Tokyo",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
    });

    const eventTypeLabelMap = {
      IN: "出勤",
      OUT: "退勤",
      OUTING: "外出",
      RETURN: "戻り",
    };

    const escapeHtml = (text) =>
      String(text || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");

    const parseTime = (iso) => {
      if (!iso) return null;
      const dt = new Date(iso);
      if (Number.isNaN(dt.getTime())) return null;
      return dt;
    };

    const formatTime = (iso) => {
      const dt = parseTime(iso);
      return dt ? clockFmt.format(dt) : "";
    };

    const formatDateTime = (iso) => {
      const dt = parseTime(iso);
      if (!dt) return "";
      return `${ymdFmt.format(dt).replaceAll("/", "-")} ${clockFmt.format(dt)}`;
    };

    const minutesToHHMM = (minutes) => {
      const total = Math.max(0, Number(minutes || 0));
      const hh = String(Math.floor(total / 60)).padStart(2, "0");
      const mm = String(total % 60).padStart(2, "0");
      return `${hh}:${mm}`;
    };

    const showToast = (message, kind = "ok") => {
      if (!message) return;
      const toast = document.createElement("div");
      toast.className = `toast toast--${kind}`;
      toast.innerHTML = `
        <p>${escapeHtml(message)}</p>
        <button type="button" class="toast__close" aria-label="閉じる">×</button>
      `;
      toastRegion.appendChild(toast);

      const remove = () => {
        toast.classList.add("toast--closing");
        window.setTimeout(() => toast.remove(), 180);
      };

      toast.querySelector(".toast__close")?.addEventListener("click", remove);
      window.setTimeout(remove, 3400);
    };

    const setTimeCell = (valueId, subId, value) => {
      const valueNode = document.getElementById(valueId);
      const subNode = document.getElementById(subId);
      const filled = Boolean(value);
      if (valueNode) valueNode.textContent = filled ? value : "—";
      if (subNode) subNode.textContent = filled ? "記録済み" : "未打刻";
    };

    const isOutingNow = (events) => {
      const travel = (Array.isArray(events) ? events : [])
        .filter((ev) => ev?.event_type === "OUTING" || ev?.event_type === "RETURN")
        .sort((a, b) => String(a?.event_time || "").localeCompare(String(b?.event_time || "")));
      if (!travel.length) return false;
      return travel[travel.length - 1].event_type === "OUTING";
    };

    const syncPrimaryAction = (status) => {
      if (!primaryForm || !primaryButton) return;
      if (status === "未出勤") {
        primaryForm.action = "/events/clock-in";
        primaryForm.dataset.clockAction = "clock-in";
        primaryButton.disabled = false;
        primaryButton.textContent = "出勤";
        return;
      }
      if (status === "出勤済") {
        primaryForm.action = "/events/clock-out";
        primaryForm.dataset.clockAction = "clock-out";
        primaryButton.disabled = false;
        primaryButton.textContent = "退勤";
        return;
      }
      primaryForm.dataset.clockAction = "done";
      primaryButton.disabled = true;
      primaryButton.textContent = "退勤済";
    };

    const syncSecondaryAction = (status, events) => {
      if (!secondaryForm || !secondaryButton) return;
      if (status !== "出勤済") {
        secondaryForm.action = "/events/outing";
        secondaryForm.dataset.clockAction = "disabled";
        secondaryButton.textContent = "外出/戻り";
        secondaryButton.disabled = true;
        return;
      }

      if (isOutingNow(events)) {
        secondaryForm.action = "/events/return";
        secondaryForm.dataset.clockAction = "return";
        secondaryButton.textContent = "戻り";
      } else {
        secondaryForm.action = "/events/outing";
        secondaryForm.dataset.clockAction = "outing";
        secondaryButton.textContent = "外出";
      }
      secondaryButton.disabled = false;
    };

    const renderTimeList = (id, values) => {
      const target = document.getElementById(id);
      if (!target) return;
      target.innerHTML = "";
      if (!values.length) {
        const li = document.createElement("li");
        li.className = "time-list__empty";
        li.textContent = "記録なし";
        target.appendChild(li);
        return;
      }
      values.forEach((value) => {
        const li = document.createElement("li");
        li.className = "time-list__item";
        li.textContent = value;
        target.appendChild(li);
      });
    };

    const renderOutingReturn = (events) => {
      const outing = [];
      const returning = [];
      (Array.isArray(events) ? events : []).forEach((ev) => {
        const time = formatTime(ev?.event_time);
        if (!time) return;
        if (ev?.event_type === "OUTING") outing.push(time);
        if (ev?.event_type === "RETURN") returning.push(time);
      });
      renderTimeList("outing-list", outing);
      renderTimeList("return-list", returning);
      const countNode = document.getElementById("outing-count");
      if (countNode) countNode.textContent = `${outing.length + returning.length}件`;
    };

    const renderMom = (mom) => {
      const node = document.getElementById("kpi-work-mom");
      if (!node) return;
      const pct = mom && typeof mom.percent_change === "number" ? mom.percent_change : null;
      if (pct === null) {
        node.innerHTML = '<span class="muted">前月比 —</span>';
        return;
      }
      const cls = pct >= 0 ? "gain" : "loss";
      const sign = pct > 0 ? "+" : "";
      node.innerHTML = `<span class="${cls}">前月比 ${sign}${pct}%</span>`;
    };

    const renderSummary = (summary, mom) => {
      const work = document.getElementById("kpi-work");
      const overtime = document.getElementById("kpi-overtime");
      const missing = document.getElementById("kpi-missing");
      if (work) work.textContent = minutesToHHMM(summary?.work_minutes || 0);
      if (overtime) overtime.textContent = minutesToHHMM(summary?.overtime_minutes || 0);
      if (missing) missing.textContent = `${Number(summary?.missing_count || 0)}日`;
      renderMom(mom || {});
    };

    const attachHistoryEditHandlers = () => {
      document.querySelectorAll(".history-edit-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          const row = btn.closest("tr[data-event-id]");
          if (!row || !editEventId || !editEventTime || !editEventType || !editEventNote) return;
          editEventId.value = row.dataset.eventId || "";
          editEventType.value = row.dataset.eventType || "IN";
          editEventTime.value = row.dataset.eventTime || "";
          editEventNote.value = row.dataset.eventNote || "";
          openEditModal();
        });
      });
    };

    const renderRecentEvents = (rows) => {
      if (!recentBody) return;
      const list = Array.isArray(rows) ? rows : [];
      if (!list.length) {
        recentBody.innerHTML = '<tr><td colspan="5" class="muted">打刻履歴がありません</td></tr>';
        return;
      }
      recentBody.innerHTML = list
        .map((ev) => {
          const editedBadge = ev?.is_edited
            ? '<span class="status status--submitted">修正</span>'
            : '<span class="status">通常</span>';
          const eventType = String(ev?.event_type || "").toUpperCase();
          const eventTypeLabel = ev?.event_type_label || eventTypeLabelMap[eventType] || eventType;
          const eventTimeLabel = ev?.event_time_label || formatDateTime(ev?.event_time);
          const note = ev?.note ? escapeHtml(ev.note) : "—";
          return `
            <tr
              data-event-id="${escapeHtml(ev?.event_id || "")}"
              data-event-type="${escapeHtml(eventType)}"
              data-event-time="${escapeHtml(ev?.event_time_input || "")}"
              data-event-note="${escapeHtml(ev?.note || "")}"
            >
              <td>${escapeHtml(eventTimeLabel)}</td>
              <td>${escapeHtml(eventTypeLabel)}</td>
              <td>${note}</td>
              <td>${editedBadge}</td>
              <td><button class="btn btn--small btn--ghost history-edit-btn" type="button">編集</button></td>
            </tr>
          `;
        })
        .join("");
      attachHistoryEditHandlers();
    };

    const patchTodayView = async () => {
      const res = await fetch("/attendance/today", { headers: { Accept: "application/json" } });
      if (!res.ok) return;
      const payload = await res.json();
      if (!payload?.ok) return;

      if (statusEl && payload.status) statusEl.textContent = payload.status;
      syncPrimaryAction(payload.status || "");
      syncSecondaryAction(payload.status || "", payload?.record?.events || []);

      const rec = payload.record || {};
      setTimeCell("clock-in-value", "clock-in-sub", rec.clock_in);
      setTimeCell("clock-out-value", "clock-out-sub", rec.clock_out);
      renderOutingReturn(rec.events || []);
      renderSummary(payload.summary || {}, payload.mom || {});
      renderRecentEvents(payload.recent_events || []);
    };

    const submitClock = async (form) => {
      const actionKind = form.dataset.clockAction || "";
      if (actionKind === "done") {
        showToast("本日の打刻は完了しています", "error");
        return;
      }
      if (actionKind === "disabled") {
        showToast("勤務中のみ操作できます", "error");
        return;
      }

      const submit = form.querySelector("button[type='submit']");
      if (submit) submit.disabled = true;
      form.classList.add("is-submitting");

      try {
        const res = await fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: { Accept: "application/json" },
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok || !payload?.ok) {
          const reason = payload?.error ? `: ${payload.error}` : "";
          showToast(`打刻に失敗しました${reason}`, "error");
          return;
        }

        const stamp = formatDateTime(payload?.event?.event_time);
        const actionLabelMap = {
          "clock-in": "出勤しました",
          "clock-out": "退勤しました",
          outing: "外出しました",
          return: "戻りました",
        };
        const actionLabel = actionLabelMap[actionKind] || "打刻しました";
        showToast(stamp ? `${actionLabel} ${stamp}` : actionLabel, "ok");
        await patchTodayView();
      } catch (_err) {
        showToast("打刻に失敗しました", "error");
      } finally {
        if (submit) submit.disabled = false;
        form.classList.remove("is-submitting");
      }
    };

    const openEditModal = () => {
      if (!modal || !modalBackdrop) return;
      modal.hidden = false;
      modalBackdrop.hidden = false;
      document.body.classList.add("modal-open");
    };

    const closeEditModal = () => {
      if (!modal || !modalBackdrop) return;
      modal.hidden = true;
      modalBackdrop.hidden = true;
      document.body.classList.remove("modal-open");
    };

    const submitEventEdit = async () => {
      if (!editForm || !editEventId) return;
      const eventId = editEventId.value;
      if (!eventId) return;
      if (!window.confirm("この修正は履歴に残ります。保存しますか？")) return;

      if (editSubmit) editSubmit.disabled = true;
      try {
        const res = await fetch(`/events/${encodeURIComponent(eventId)}/edit`, {
          method: "POST",
          body: new FormData(editForm),
          headers: { Accept: "application/json" },
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok || !payload?.ok) {
          const reason = payload?.error ? `: ${payload.error}` : "";
          showToast(`打刻修正に失敗しました${reason}`, "error");
          return;
        }
        const stamp = formatDateTime(payload?.event?.event_time);
        showToast(stamp ? `打刻修正を保存しました ${stamp}` : "打刻修正を保存しました", "ok");
        closeEditModal();
        await patchTodayView();
      } catch (_err) {
        showToast("打刻修正に失敗しました", "error");
      } finally {
        if (editSubmit) editSubmit.disabled = false;
      }
    };

    document.querySelectorAll("form[data-clock-action]").forEach((form) => {
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        submitClock(form);
      });
    });

    if (editClose) editClose.addEventListener("click", closeEditModal);
    if (editCancel) editCancel.addEventListener("click", closeEditModal);
    if (modalBackdrop) modalBackdrop.addEventListener("click", closeEditModal);
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeEditModal();
    });
    if (editForm) {
      editForm.addEventListener("submit", (event) => {
        event.preventDefault();
        submitEventEdit();
      });
    }

    const tick = () => {
      const now = new Date();
      clockEl.textContent = clockFmt.format(now);
      dateEl.textContent = dateFmt.format(now).replaceAll("/", ".");
    };

    tick();
    window.setInterval(tick, 1000);
    attachHistoryEditHandlers();

    const initialMessage = flashNode?.dataset?.message || "";
    const initialError = flashNode?.dataset?.error || "";
    if (initialMessage) showToast(initialMessage, "ok");
    if (initialError) showToast(initialError, "error");

    patchTodayView().catch(() => {
      showToast("最新状態の取得に失敗しました", "error");
    });
  })();
</script>
{% endblock %}
