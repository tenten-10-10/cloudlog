{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h1>打刻管理</h1>

  {% if flash_error %}
  <p class="error">{{ flash_error }}</p>
  {% endif %}
  {% if flash_message %}
  <p class="notice">{{ flash_message }}</p>
  {% endif %}

  <form method="get" action="/admin/attendance" class="inline-form wrap attendance-filter">
    <label>対象ユーザー
      <select name="user_id">
        <option value="">全員</option>
        {% for u in users %}
        <option value="{{ u.id }}" {% if selected_user_id == u.id %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>
    </label>
    <label>開始日
      <input type="date" name="from_date" value="{{ from_date }}" />
    </label>
    <label>終了日
      <input type="date" name="to_date" value="{{ to_date }}" />
    </label>
    <button class="btn" type="submit">表示</button>
  </form>
</section>

<section class="panel">
  <h2>全ユーザー打刻履歴</h2>
  <table>
    <thead>
      <tr>
        <th>ユーザー</th>
        <th>日付</th>
        <th>出勤時刻</th>
        <th>退勤時刻</th>
        <th>労働時間(h)</th>
        <th>更新者</th>
        <th>備考</th>
        <th>修正</th>
      </tr>
    </thead>
    <tbody>
      {% for item in history %}
      <tr>
        <td>{{ item.row.username }}</td>
        <td>{{ item.row.work_date }}</td>
        <td>{{ fmt_ts_jst(item.row.clock_in_at) }}</td>
        <td>{{ fmt_ts_jst(item.row.clock_out_at) }}</td>
        <td>{{ item.worked_hours }}</td>
        <td>{{ item.row.updated_by_username or "-" }}</td>
        <td>{{ item.row.note or "-" }}</td>
        <td>
          <details>
            <summary>修正</summary>
            <form method="post" action="/admin/attendance/{{ item.row.id }}" class="form-grid compact admin-attendance-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <input type="hidden" name="from_date" value="{{ from_date }}" />
              <input type="hidden" name="to_date" value="{{ to_date }}" />
              <input type="hidden" name="user_id" value="{{ selected_user_id if selected_user_id else '' }}" />
              <label>出勤時刻
                <input type="datetime-local" name="clock_in_at" value="{{ to_datetime_local(item.row.clock_in_at) }}" />
              </label>
              <label>退勤時刻
                <input type="datetime-local" name="clock_out_at" value="{{ to_datetime_local(item.row.clock_out_at) }}" />
              </label>
              <label>備考
                <input type="text" name="note" value="{{ item.row.note }}" maxlength="500" />
              </label>
              <label>修正理由（必須）
                <input type="text" name="reason" required maxlength="500" />
              </label>
              <button class="btn" type="submit">保存</button>
            </form>
          </details>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8">打刻データがありません</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}
